version: 2

jobs:
  tests:
    docker:
      - image: circleci/python:3.7-browsers
      - image: circleci/mysql:5.7
        environment:
          MYSQL_ROOT_PASSWORD: creme
          MYSQL_DATABASE: cremecrm
    steps:
      - checkout

      - run:
          name: Wait for db
          command: dockerize -wait tcp://localhost:3306 -timeout 1m

      - run:
          name: Install system dependencies
          command: |
            sudo apt update
            sudo apt install -y python-dev graphviz libgraphviz-dev pkg-config mariadb-client

      # Download and cache dependencies
      - restore_cache:
          keys:
            - creme_crm-{{ checksum "creme/requirements.txt" }}-{{ checksum "creme/requirements-dev.txt" }}-{{ checksum "creme/requirements-mysql.txt" }}
            - creme_crm

      - run:
          name: Install Python dependencies
          command: |
            python3 -m venv ~/venv
            . ~/venv/bin/activate
            pip install -r creme/requirements-dev.txt
            pip install -r creme/requirements-mysql.txt
            echo "source ~/venv/bin/activate" >> $BASH_ENV

      - save_cache:
          key: creme_crm-{{ checksum "creme/requirements.txt" }}-{{ checksum "creme/requirements-dev.txt" }}-{{ checksum "creme/requirements-mysql.txt" }}
          paths: "~/venv"

      - run: pip list --outdated

      - run: cp ~/project/.circleci/local_settings.py creme/
      - run: python manage.py migrate
      - run: python manage.py creme_populate
      - run: python manage.py generatemedia
      - run: COVERAGE_PROCESS_START=.coveragerc coverage run --source creme/ manage.py test --noinput --parallel=8
      - run: coverage combine
      - run: coverage report
      - run: coverage html

      - store_artifacts:
          path: htmlcov

  lint-isort:
    docker:
      - image: circleci/python:3.7
    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
          keys:
            - creme_crm-{{ checksum "creme/requirements.txt" }}-{{ checksum "creme/requirements-dev.txt" }}
            - creme_crm

      - run:
          name: Install Python dependencies
          command: |
            python3 -m venv ~/venv
            . ~/venv/bin/activate
            pip install -r creme/requirements-dev.txt
            echo "source ~/venv/bin/activate" >> $BASH_ENV

      - save_cache:
          key: creme_crm-{{ checksum "creme/requirements.txt" }}-{{ checksum "creme/requirements-dev.txt" }}
          paths: "~/venv"

      - run: pip install isort
      - run: git diff --name-only origin/master creme/ | { grep '.py$' || true; } | xargs --no-run-if-empty isort --check --diff --atomic

  tests-js:
    docker:
     - image: circleci/python:3.7-node-browsers
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo apt update
            sudo apt install -y python-dev graphviz libgraphviz-dev pkg-config

      # Download and cache dependencies
      - restore_cache:
          keys:
            - creme_crm-{{ checksum "creme/requirements.txt" }}-{{ checksum "creme/requirements-dev.txt" }}
            - creme_crm

      - run:
          name: Install Python dependencies
          command: |
            python3 -m venv ~/venv
            . ~/venv/bin/activate
            pip install -r creme/requirements-dev.txt
            echo "source ~/venv/bin/activate" >> $BASH_ENV

      - save_cache:
          key: creme_crm-{{ checksum "creme/requirements.txt" }}-{{ checksum "creme/requirements-dev.txt" }}
          paths: "~/venv"

      - restore_cache:
          key: node-dependencies-{{ checksum "package-lock.json" }}

      - run:
         name: Install nodejs dependencies
         command: |
           npm install

      - save_cache:
          key: node-dependencies-{{ checksum "package-lock.json" }}
          paths:
           - node_modules

      - run:
          name: Run javascript tests
          command: |
            python manage.py generatemedia
            node_modules/.bin/karma start .karma.conf.js --browsers=FirefoxHeadless

  lint-js:
    docker:
     - image: circleci/python:3.7-node-browsers
    steps:
      - checkout
      - run:
          name: Install eslint dependencies
          command: |
            npm install
      - run:
          name: Run linter
          command: |
            node_modules/.bin/eslint --config .eslintrc --ignore-path .eslintignore --format stylish --quiet creme/

workflows:
  version: 2
  build:
    jobs:
      - lint-isort
      - lint-js
      - tests-js:
          requires:
           - lint-js
      - tests:
          requires:
           - lint-isort
