{% extends 'creme_core/bricks/base/hat-card.html' %}
{% load i18n creme_bricks creme_widgets persons_tags %}
{% load format_amount has_perm_to from creme_core_tags %}

{% block brick_extra_class %}{{block.super}} opportunities-card-brick{% endblock %}

{% block card_intro_content %}
{% include 'persons/bricks/frags/card-last-activity.html' %}
{% endblock %}

{% block card_title %}
    {{block.super}}
    {% if not object.is_deleted and not object.sandbox %}
    {% brick_card_action_for_field instance=object field='name' user=user %}
    {% endif %}
{% endblock %}

{% block card_indicators %}
    {% if is_neglected %}
    <div class='business-card-indicator business-card-warning-indicator' title="{% translate 'Meeting, phone call…' %}">{% translate 'No activity since 30 days' %}</div>
    {% endif %}
{% endblock %}

{% block card_secondary %}
    <div class="card-targets">
        {% if target_is_organisation %}
        <span class="card-function">{% translate 'Targets the organisation' %}</span> {% widget_entity_hyperlink target user %}
        {% else %}
        <span class="card-function">{% translate 'Targets the contact' %}</span>{% has_perm_to view target as target_view_perm %}
            {% if target_view_perm %}
            <a href='{{target.get_absolute_url}}' {% if target.is_deleted %}class="is_deleted"{% endif %}>{{target|persons_pretty_contact}}</a>{% persons_contact_first_employer contact=target user=user as employer %}
                {% if employer %},
                {% if employer.as_manager %}{% translate 'manager of the organisation' %}{% else %}{% translate 'employee of the organisation' %}{% endif %}
                {% widget_entity_hyperlink employer.organisation user %}
                {% endif %}
            {% else %}
                {{HIDDEN_VALUE}}
            {% endif %}
        {% endif %}
    </div>
{% endblock %}

{% block card_fields_title %}
{% translate 'Details' context 'opportunities' %}
{% endblock %}

{% block card_fields %}
    <div class="card-info-field">
        <span class='card-info-key'>{% translate 'Sales phase' %}</span>
        <span class='card-info-value'>
            {{object.sales_phase|default:'—'}}
            {% brick_card_action_for_field instance=object field='sales_phase' user=user %}
        </span>
    </div>
    {% if 'estimated_sales' not in hidden_fields %}
    <div class="card-info-field">
        <span class='card-info-key'>{% translate 'Estimated sales' %}</span>
        <span class='card-info-value'>
            {% if object.estimated_sales is None %}
            —
            {% else %}
            {{object.estimated_sales|format_amount:object.currency}}
            {% endif %}
            {% brick_card_action_for_field instance=object field='estimated_sales' user=user %}
        </span>
    </div>
    {% endif %}
    {% if 'made_sales' not in hidden_fields %}
    <div class="card-info-field">
        <span class='card-info-key'>{% translate 'Made sales' %}</span>
        <span class='card-info-value'>
            {% if object.made_sales is None %}
            —
            {% else %}
            {{object.made_sales|format_amount:object.currency}}
            {% endif %}
            {% brick_card_action_for_field instance=object field='made_sales' user=user %}
        </span>
    </div>
    {% endif %}
{% endblock %}

{% block card_summary %}
    {% include 'persons/bricks/frags/card-summary-acts.html' %}
    {% with paginator=contacts.paginator %}
        <div class="card-info-field">
            <div class="card-info-field">
                <span class='card-info-key'>
                    {% if paginator.count == 0 %}
                        {% translate 'Linked contacts' %}
                    {% else %}
                        {% blocktranslate count count=paginator.count %}{{count}} Linked contact{% plural %}{{count}} Linked contacts{% endblocktranslate %}
                    {% endif %}
                </span>
                <span class='card-info-value'>
                    {% for contact in contacts.object_list %}{% widget_join %}{% widget_entity_hyperlink contact user %}{% end_widget_join %}{% empty %}—{% endfor %}
                    {% if paginator.num_pages > 1 %}…{% endif %}
                </span>
            </div>
        </div>
    {% endwith %}
    {% include 'persons/bricks/frags/card-summary-next-activity.html' %}
{% endblock %}
